<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —É–≥—Ä–æ–∑</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f6f8; }
    .post { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
    .actions button { margin-right: 10px; cursor: pointer; }
    .analysis { font-size: 0.9em; color: #555; margin-top: 5px; }
    textarea { width: 100%; padding: 10px; margin-bottom: 10px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; }
    button.submit { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; }
    canvas { max-width: 600px; margin-top: 30px; background: #fff; padding: 20px; border-radius: 10px; }
  </style>
</head>
<body>

  <h1>–õ–µ–Ω—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π</h1>

  <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–æ—Å—Ç</h3>
  <textarea id="postText" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞..."></textarea>
  <button class="submit" onclick="submitPost()">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>

  <hr />
  <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–≥—Ä–æ–∑</h2>
  <canvas id="threatChart"></canvas>
  <hr />

  <div id="posts"></div>

  <script>
    let stats = { toxic: 0, fake: 0, hate: 0, total: 0 };

    async function fetchPosts() {
      const res = await fetch("/api/posts");
      const data = await res.json();
      const container = document.getElementById("posts");
      container.innerHTML = "";
      stats = { toxic: 0, fake: 0, hate: 0, total: data.length };

      data.forEach((post, index) => {
        const div = document.createElement("div");
        div.className = "post";
        const pid = "post-" + index;

        const isToxic = Object.entries(post.toxicity || {}).some(([label, score]) => score > 0.5 && label !== 'non-toxic');
        const isFake = post.fake_news.label.toLowerCase().includes("fake") && post.fake_news.score > 0.5;
        const isHate = post.hate_speech.label.toLowerCase().includes("hate") && post.hate_speech.score > 0.5;

        if (isToxic) stats.toxic++;
        if (isFake) stats.fake++;
        if (isHate) stats.hate++;

        div.innerHTML = `
          <p>${post.text}</p>
          <div class="analysis">
            <b>Toxicity:</b> ${JSON.stringify(post.toxicity)}<br>
            <b>Fake news:</b> ${post.fake_news.label} (${post.fake_news.score.toFixed(2)})<br>
            <b>Hate speech:</b> ${post.hate_speech.label} (${post.hate_speech.score.toFixed(2)})
          </div>
          <div class="actions">
            <button onclick="interact('${pid}', 'like')">üëç</button>
            <button onclick="interact('${pid}', 'dislike')">üëé</button>
            <button onclick="interact('${pid}', 'repost')">üí¨ –†–µ–ø–æ—Å—Ç</button>
            <button onclick="interact('${pid}', 'hide')">üôà –°–∫—Ä—ã—Ç—å</button>
          </div>
        `;

        div.dataset.postId = pid;
        container.appendChild(div);
      });

      renderChart();
    }

    async function interact(pid, action) {
      await fetch("/api/interact", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ post_id: pid, action })
      });
    }

    async function submitPost() {
      const text = document.getElementById("postText").value;
      if (!text.trim()) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!");

      const analyze = await fetch("/api/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });

      const result = await analyze.json();

      await fetch("/api/save_post", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text,
          toxicity: result.toxicity,
          fake_news: result.fake_news,
          hate_speech: result.hate_speech
        })
      });

      document.getElementById("postText").value = "";
      fetchPosts();
    }

    function renderChart() {
      const ctx = document.getElementById('threatChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Toxic', 'Fake', 'Hate'],
          datasets: [{
            label: '–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —É–≥—Ä–æ–∑',
            data: [stats.toxic, stats.fake, stats.hate],
            backgroundColor: ['#ff4d4f', '#fa8c16', '#722ed1']
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }

    fetchPosts();
  </script>
</body>
</html>
